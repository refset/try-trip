<h1>Try Trip: Datalog as a namespace</h1><p>This webpage showcases <a href='https://github.com/juxt/trip/'>Trip</a>&mdash;a <a href='https://github.com/juxt/trip/blob/main/src/juxt/trip/core.cljc'>single-namespace</a> library for Clojure that compiles <a href='https://github.com/tonsky/datascript'>DataScript</a>-compatible Datalog into <code>for</code> loops&mdash;and is derived from Borkdude's excellent <a href='https://borkdude.github.io/cljs-showcase'>cljs-showcase</a> template.</p><p>The interactive snippets below are made possible using a combination of ClojureScript & <a href='https://github.com/babashka/sci'>SCI</a>. SCI is required to support Trip's need for runtime access to <code>cljs.core/&#42;eval&#42;</code> (<code>eval</code> is used internally for query compilation).</p><p>The API documentation for Trip can be browsed <a href='https://github.com/juxt/trip/blob/main/API.md'>here</a>. <div style="width: 600px;" class="cljs-showcase"></p><pre><code class="clojure">&#40;+ &quot;Hello, &quot; &quot;ClojureScript REPL!&quot;&#41;
</code></pre><p></div></p><p>Very basic error messages also show up as results: <div style="width: 600px;" class="cljs-showcase"></p><pre><code class="clojure">&#40;+ foo 1&#41;
</code></pre><p></div></p><p>The Trip namespace is available to be require'd, so let's create our first database! <div style="width: 600px;" class="cljs-showcase" data-cljs-showcase-no-editable="true"></p><pre><code class="clojure">&#40;require '&#91;juxt.trip.core :as trip&#93;&#41;
&#40;def t &#40;trip/create-conn&#41;&#41; ;; an atom containing the result of `&#40;trip/empty-db&#41;`
</code></pre><p></div></p><p>A quick a look at the value of <code>t</code> shows that Trip's three internal indexes are empty: <div style="width: 600px;" class="cljs-showcase"></p><pre><code class="clojure">@t ;; equivalent to `&#40;trip/db t&#41;`
</code></pre><p></div></p><p>Trip is completely schemaless, so can we simply insert a map containing a user-specified <code>db/id</code> value to create an entity in our database: <div style="width: 600px;" class="cljs-showcase"></p><pre><code class="clojure">&#40;trip/transact! t &#91;{:db/id :foo :ref :bar}&#93;&#41;
</code></pre><p></div></p><p>You can see that triples are printed as maps and the three indexes (<code>EAV</code>, <code>AEV</code>, <code>AVE</code>) have been populated ready for querying.</p><p>Now we can take a <code>db</code> value and query it with Datalog. Here we are asking for the set of all known IDs: <div style="width: 600px;" class="cljs-showcase"></p><pre><code class="clojure">&#40;-&gt;&gt; &#40;trip/db t&#41;
     &#40;trip/q '{:find &#91;?e&#93;
               :where &#91;&#91;?e :db/id&#93;&#93;}&#41;&#41;
</code></pre><p></div></p><p>Explicit IDs underpin the dynamic and schemaless experience of using Trip, however this also means that updates happen at the granularity of entire entities. Transacting a new map for an existing entity will first retract all existing triples for that ID and then add the complete new set of triples (i.e. there is some cost of redundant work to the flexibility): <div style="width: 600px;" class="cljs-showcase"></p><pre><code class="clojure">&#40;-&gt; &#40;trip/transact! t &#91;{:db/id :foo
                       :ref :bar
                       :val {:nested &#91;:thing&#93;}}&#93;&#41;
    :tx-data&#41;
</code></pre><p></div></p><p>If we insert an entity with an ID that happens to correlate with an existing value under an attribute, we can dynamically treat is as if it were a "reference" type attribute: <div style="width: 600px;" class="cljs-showcase"></p><pre><code class="clojure">&#40;trip/transact! t &#91;{:db/id :bar :val &quot;joined!&quot;}&#93;&#41;
&#40;-&gt;&gt; &#40;trip/db t&#41;
     &#40;trip/q '{:find &#91;?v&#93;
               :where &#91;&#91;:foo :ref ?e2&#93;
                       &#91;?e2 :val ?v&#93;&#93;}&#41;&#41;
</code></pre><p></div></p><p>This kind of dynamic behaviour is often referred to as "schema on read", which offers some benefits while prototyping&mdash;for instance it allows you to transact entities that refer to each other without worrying about dependency ordering&mdash;but it does mean you might want to consider enforcing referential integrity constraints through other means.</p><p>One way you can enforce constraints is by using Datalog to test for invariants during the <code>transact!</code> processing, which we can achieve by using Trip's transaction function capability:</p><p><div style="width: 600px;" class="cljs-showcase"></p><pre><code class="clojure">;; reset the example data when evaluating the following snippet multiple times
&#40;trip/transact! t &#91;&#91;:db.fn/retractEntity :baz&#93; &#91;:db.fn/retractEntity :foo2&#93;&#93;&#41;

&#40;-&gt; &#40;trip/transact! t &#91;{:db/id :baz :exists? true} ;; try commenting out this operation
                       &#91;:db.fn/call &#40;fn &#91;db doc&#93;
                                      &#40;if &#40;empty? &#40;trip/q '{:find &#91;?e&#93;
                                                            :in &#91;$ ?e&#93;
                                                            :where &#91;&#91;?e :db/id&#93;&#93;}
                                                          db
                                                          &#40;:ref doc&#41;&#41;&#41;
                                          &#91;&#91;:db.fn/cas :cancel-tx :cancel-tx :cancel-tx :cancel-tx&#93;&#93;
                                          &#91;doc&#93;&#41;&#41;
                                    {:db/id :foo2 :ref :baz}&#93;&#93;&#41;
    :tx-data&#41;
</code></pre><p></div></p><p>Should you wish to quickly compare Trip's API with DataScript, note that it is also available to be require'd throughout this webpage:</p><p><div style="width: 600px;" class="cljs-showcase"></p><pre><code class="clojure">&#40;require '&#91;datascript.core :as d&#93;&#41;
&#40;d/empty-db&#41;
</code></pre><p></div></p><p>That's a wrap! Thanks for taking a look at Trip and please give the <a href='https://github.com/juxt/trip/'>repo</a> a star. PRs, Issues and questions are welcome üôè</p><p><script src="js/main.js" type="application/javascript"></script></p>